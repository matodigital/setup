#!/usr/bin/env bash
set -euo pipefail

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

RATPOISON_DIR="$HOME/ratpoison"
RATPOISON_PATCHES_DIR="$HOME/ratpoison-patches"

trap 'echo -e "${RED}[✗] Script failed at line $LINENO.${NC}" >&2' ERR

cd "$HOME"
echo -e "${YELLOW}[!] Cleaning old directories...${NC}"
rm -rf "$RATPOISON_DIR" "$RATPOISON_PATCHES_DIR"

echo -e "${BLUE}[*] Cloning ratpoison...${NC}"
git clone https://git.savannah.nongnu.org/git/ratpoison.git "$RATPOISON_DIR"

echo -e "${BLUE}[*] Cloning ratpoison patches...${NC}"
git clone https://github.com/matodigital/ratpoison-patches.git "$RATPOISON_PATCHES_DIR"

PATCHES=(
        "001-add-removeleft-up-right-down-commands.patch"
        "002-manpage-layout-fixes.patch"
        "003-ignorehints.patch"
        "004-EWMH.patch"
        "005-EWMH.patch"
        "006-EWMH.patch"
        "007-EWMH.patch"
)

echo -e "${BLUE}[*] Moving patches into ratpoison directory...${NC}"
for patch in "${PATCHES[@]}"; do
        mv "$RATPOISON_PATCHES_DIR/$patch" "$RATPOISON_DIR"
done

rm -rf "$RATPOISON_PATCHES_DIR"

cd "$RATPOISON_DIR"
for patch in "${PATCHES[@]}"; do
        echo -e "${YELLOW}[>] Applying ${patch}...${NC}"
        patch -p1 <"$patch"
done

echo -e "${BLUE}[*] Removing applied patches...${NC}"
rm -rf "${PATCHES[@]}"

echo -e "${BLUE}[*] Running autogen.sh...${NC}"
./autogen.sh

echo -e "${BLUE}[*] Running configure...${NC}"
./configure

echo -e "${BLUE}[*] Building and installing...${NC}"
sudo make install

cd "$HOME"
echo -e "${BLUE}[*] Cleaning up ratpoison source...${NC}"
rm -rf "$RATPOISON_DIR"

echo -e "${GREEN}[✓] Ratpoison patched, built, and installed successfully!${NC}"
